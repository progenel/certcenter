:toc-title: Содержание
= Техническое задание
:toc:
:doctype: article

== Введение
Криптография нужна организациям, чтобы контролировать доступ к данным и сервисам: шифровать документы и файлы, подписывать важные договоры, пускать сотрудников в VPN по сертификатам и вовремя отзывать доступ. Наше решение — внутренний центр сертификации и сервис шифрования для МСП с минимальными зависимостями (SQLite + локальные файлы), чтобы быстро развернуть и показать работу выпуска/отзыва сертификатов и шифрования.

=== Краткое описание
Внутренний CA (один онлайн), выдача сертификатов X.509 для подписи, шифрования и VPN, сервис шифрования файлов, аудит. В MVP: локальное хранилище артефактов и SQLite; OCSP/LDAP/S3/Redis — опционально.

=== Простое описание
Система выдает «цифровые пропуска» (сертификаты) для сотрудников: с ними можно подписывать и шифровать файлы и подключаться к VPN. Офицер безопасности выдает и отзывает пропуска, администратор настраивает сервисы, пользователи получают свой пропуск и работают с файлами, аудитор видит журнал. Файлы можно шифровать «адресно» — их откроют только указанные получатели; подписи позволяют заметить любое изменение.

== Назначение системы
* Обеспечить выпуск, управление и отзыв сертификатов X.509 для подписи, шифрования и VPN-доступа внутри МСП.
* Дать безопасный обмен данными: шифрование файлов на открытые ключи, публикация цепочки/CRL для проверки статуса сертификатов (OCSP — следующий этап).
* Поддержать юридически значимую подпись документов и интеграцию в процессы ЭДО/Workflow (проверка цепочки/статуса перед принятием).
* Обеспечить аудит действий и прозрачность для ролей: администратор, офицер безопасности/криптоофицер, сотрудник, аудитор.
* Снизить сложность внедрения для МСП: минимальные зависимости (SQLite + локальное хранилище артефактов), опциональный LDAP/AD.

== Роли и пользователи
* Администратор: управление пользователями, ролями, интеграциями, настройками CA.
* Офицер безопасности / криптоофицер: управление профилями сертификатов, выпуск/отзыв, контроль политик и CRL (OCSP — опционально позже).
* Сотрудник (пользователь): запрос и получение сертификатов, шифрование/расшифрование файлов.
* Аудитор: просмотр журналов, отчеты, контроль соблюдения политики.

== Требования
=== Функциональные требования
* FR-01 Заявка на выпуск сертификата для подписи, шифрования и VPN через UI/CLI/API.
* FR-02 Выпуск сертификата с коротким сроком жизни, при серверной генерации — выдача PKCS#12; при клиентской — прием CSR.
* FR-03 Продление/перевыпуск сертификата (новый serial, новые даты; при серверной генерации — новый ключ).
* FR-04 Отзыв сертификата с обновлением CRL (OCSP — следующий этап).
* FR-05 Публикация CRL и цепочек CA в общедоступном хранилище (MVP — локальные файлы).
* FR-06 Проверка статуса сертификата (CRL) доступна через API.
* FR-07 Шифрование файлов: AES-GCM, обертка ключа публичными ключами получателей (сертификаты или загруженный публичный ключ), расшифрование своим приватным ключом.
* FR-08 Управление профилями сертификатов (EKU, сроки жизни, политики DN).
* FR-09 Интеграция с LDAP/AD для аутентификации и получения атрибутов пользователя (в MVP — локальные учетные записи).
* FR-10 Уведомления об истечении/отзыве сертификатов (последующий этап).
* FR-11 Аудит основных операций (выпуск, отзыв, доступ к артефактам, шифрование/расшифрование).
* FR-12 Загрузка цепочек/CRL/пакетов через портал.
* FR-13 Управление ролями и доступом (RBAC).

=== Нефункциональные требования
* NFR-01 Производительность: типовые операции API ≤200 мс, выпуск cert ≤2 c (при текущем размере ключей).
* NFR-02 Доступность: регулярные бэкапы БД/артефактов, восстановление CRL за ≤5 мин.
* NFR-03 Безопасность: RBAC, аудит, минимум TLS 1.2+ (в бою); в MVP — простые токены без OCSP.
* NFR-04 Масштабируемость: до 1000 пользователей, 200 одновременных запросов API (для MVP без горизонтального масштабирования).
* NFR-05 Совместимость: OpenVPN, стандартные X.509-клиенты, поддержка PKCS#12, PEM.
* NFR-06 Наблюдаемость: базовые логи (в MVP), метрики/алерты — следующий этап.
* NFR-07 Восстанавливаемость: RPO ≤ 1 час, RTO ≤ 4 часа для метаданных.
* NFR-08 Криптография: RSA 2048/3072 или ECC (P-256), AES-256-GCM для файлов.
* NFR-09 Локализация: интерфейс на русском, оглавление/документация на русском.

== Архитектура (обзор)
Контейнеры: UI/CLI → API (FastAPI) → CA core (issuer, CRL, policy, audit) → Crypto; хранилища SQLite (MVP), артефакты в локальном каталоге (опционально S3/minio позже), интеграции LDAP/AD — опционально.

== UML-диаграммы (план)
Use-case, классы, последовательности (выдача cert, шифрование файла), активности (жизненный цикл ключа), состояния (сертификат), компоненты/развертывание.

== ER-диаграмма
См. `doc/db.puml`; сущности: Users, Roles, Certificates, Artifacts (с владельцем), Envelopes, Audit.

== Структура БД
Метаданные в SQLite; артефакты (CRL, цепочки, пакеты) — локальный каталог (опционально S3/minio в следующих версиях).

== API (контракты)
REST/JSON с OpenAPI/Swagger; основные маршруты: выпуск/отзыв/получение сертификатов, публикация CRL/OCSP, загрузка пакетов, шифрование/расшифрование.

== Требования к интерфейсу
Веб-портал (упрощенный, без фреймворков): заявки, статусы, управление ключами, шифрование/расшифрование, загрузка chain/CRL, базовые подсказки по ролям.

== Прототип интерфейса (минимум 5 экранов)
* Логин.
* Дашборд (статусы сертификатов, оповещения).
* Заявка/управление сертификатами (выпуск/продление/отзыв).
* Шифрование/расшифрование файлов (выбор получателей, скачивание пакета).
* Аудит/логи и настройки интеграций (LDAP/уведомления) — поэтапно.

== План разработки
Этапы: требования → архитектура → модели БД → API каркас → CA core → CRL/OCSP → envelope → UI/CLI → тесты → документация/презентация.

== Тестовые сценарии
Выпуск/отзыв cert, проверка CRL, шифрование/расшифрование файла (2 получателя), интеграция с LDAP/AD (опционально), уведомления (если включены), отказоустойчивость CRL.

== Заключение
Критерии приемки, ограничения MVP, дальнейшие улучшения.
