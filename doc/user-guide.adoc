:toc-title: Содержание
= Руководство пользователя
:toc:
:doctype: article

== Роли и возможности

=== Администратор
* Управление пользователями (создание) и ролями (демо роли создаются автоматически).
* Публикация chain/CRL (в MVP — через артефакты в локальном хранилище).
* Базовые настройки (JWT секреты, путь к хранилищу).

=== Офицер безопасности / криптоофицер
* Выпуск/продление/отзыв сертификатов для подписи/шифрования/VPN.
* Одобрение/отклонение заявок на сертификаты.
* Контроль CRL (OCSP — вне MVP).
* Проверка статуса сертификатов (CRL/статус-API).

=== Сотрудник (пользователь)
* Запрос сертификатов (CSR или серверная генерация, PKCS#12 при серверной).
* Загрузка цепочки/CRL.
* Шифрование файлов (envelope) для других пользователей, скачивание пакетов; загрузка собственного публичного ключа для входящих пакетов.
* Расшифрование полученных пакетов своим закрытым ключом.
* Просмотр своих сертификатов и статусов (через заявки и артефакты).

=== Аудитор
* Проверка доступности CRL/chain (если опубликованы). Полный аудит — за рамками MVP.

== Минимальные сценарии по ролям
* Администратор: создает пользователя, выдает ему роль, проверяет наличие chain/CRL в артефактах.
* Офицер безопасности: одобряет заявку, выпускает/отзывает сертификат, проверяет статус по CRL.
* Сотрудник: загружает свой публичный ключ (или получает сертификат), шифрует файл на коллег, расшифровывает полученный пакет, скачивает chain/CRL.
* Аудитор: проверяет наличие опубликованных CRL/chain.

== Если LDAP/AD не настроен (MVP)
* Используются локальные учетные записи в БД.
* Администратор заводит пользователей вручную.
* Логин — через локальные учетные данные; роли назначаются администратором.

== Где что искать
* Портал/CLI: заявки на сертификаты, шифрование/расшифрование, chain/CRL.
* Документация: `doc/api.adoc`, `doc/mvp.adoc`, `doc/tz.adoc`, `doc/glossary.adoc`.
* Диаграммы: `doc/c4-containers.puml`, `doc/sequence-issue-cert.puml`, `doc/sequence-envelope.puml`.

== Шифрование и пакет (конверт) — пошагово
* Отправитель:
** Указывает получателей (логины или серийные номера/метки ключей).
** Загружает файл и жмёт «Зашифровать».
** В ответ получает `id` пакета (конверта) и список получателей/ключей.
** При необходимости скачивает пакет по `id` (кнопка «Скачать зашифрованный файл» или `GET /api/envelope/{id}/download`).
* Получатель:
** Получает `id` пакета от отправителя (или видит в UI, если авторизован).
** Вводит `ID пакета` в UI, нажимает «Получить метаданные» — видит получателей и ключи.
** Вводит свой закрытый ключ PEM (и пароль, если есть), при необходимости указывает серийный номер/метку ключа.
** Нажимает «Расшифровать» — получает содержимое в base64.

== Публикация собственного публичного ключа (для входящих файлов)
* Вставьте свой публичный ключ PEM в поле «Мой публичный ключ (для входящих шифрованных файлов)», укажите метку (например, серийный номер сертификата) и нажмите «Сохранить ключ».
* Этот ключ станет активным: при шифровании конверта отправители будут оборачивать AES-ключ вашим публичным ключом (если он найден), либо сертификатом, если его нет.
* Смена ключа деактивирует предыдущий — хранится только один активный публичный ключ на пользователя.

== Работа с ID пакета
* `ID пакета` — уникальный идентификатор конверта, возвращается при шифровании (`POST /api/envelope`).
* Используйте его для:
** Метаданные: `GET /api/envelope/{id}`.
** Скачивание: `GET /api/envelope/{id}/download`.
** Расшифровка: `POST /api/envelope/{id}/decrypt` (передавая приватный ключ PEM).

== Быстрый сценарий в UI
* Войти как `user/user` → загрузить свой публичный ключ (раздел «Шифрование / Расшифрование»).
* Создать заявку на сертификат (профиль подпись/шифрование/VPN); офицер/админ в своем логине одобряет заявку.
* Скачивать chain/CRL (артефакты) — раздел «Артефакты».
* Зашифровать файл на коллег (указать их username/серийный номер cert), скачать конверт.
* Расшифровать конверт, введя свой закрытый ключ (PEM) и, при необходимости, пароль.
