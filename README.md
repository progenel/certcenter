# CertCenter (MVP) — v0.0.187

Внутренний CA и сервис шифрования для МСП. Быстрый запуск для демонстрации: SQLite + локальное хранилище артефактов, JWT-логин, роли admin/officer/user, выдача реальных X.509, CRL.

## Требования
- Python 3.11+
- Установить зависимости:
  ```sh
  pip install -r code/requirements.txt
  ```

## Конфиг
- Копировать `.env.example` в `.env` (при необходимости поменять секрет JWT/пароли демо-пользователей).
- По умолчанию артефакты пишутся в `code/data/artifacts`, БД — `sqlite:///code/data/app.db` (пути заданы относительно каталога `code/`).

## Запуск API
```sh
cd code
uvicorn app.main:app --reload
```
Откройте UI: http://localhost:8000/ui

Демо логины:
- admin / admin (админ)
- officer / officer (офицер безопасности)
- user / user (пользователь)

## Возможности
- Выдача сертификатов X.509 с подписью демо-CA, P12 при серверной генерации.
- Заявки на ceртификат (user), одобрение/отклонение (admin/officer).
- Отзыв cert → пересборка CRL.
- Артефакты: cert PEM/P12, chain, CRL, envelope.
- Статус по CRL (`/api/certs/status/{serial}`).
- Роли и JWT, UI разделяет доступ.
- Шифрование файлов (envelope): отправитель шифрует под публичные ключи получателей (их сертификаты или явно загруженный публичный ключ). Получатель расшифровывает, предоставляя свой закрытый ключ.
- Обмен зашифрованными сообщениями: отправка текста на публичные ключи получателей, хранение и расшифровка через UI/API.
- Обновление UI: выбор файлов и ключей из своих артефактов, загрузка ключей из файлов, подстановка ID зашифрованных пакетов.

## Схема именования файлов (artifacts_path)
- `ca.key`, `ca.crt` — ключ и сертификат демо-CA.
- `chain.pem` — цепочка CA (для клиентов).
- `crl.pem` — актуальный CRL.
- Сертификаты/ключи: `{pubkey_fp}.pem`, `{pubkey_fp}.p12`, `{pubkey_fp}-key.pem`, где `pubkey_fp` — SHA-256 fingerprint публичного ключа сертификата (DER SPKI).
- Envelope: `{md5}.enc`, где `md5` — MD5 хэш исходного файла (nonce+cipher в файле; артефакты создаются для отправителя и получателей).
- Сообщения: `messages/{message_id}.enc` (AES-GCM), `message_id` — UUID.
- Пользовательские файлы: имя по MD5 содержимого (для выбора в UI).

## Сброс БД/артефактов
- При изменении схемы удалите старую БД:
  ```sh
  rm -f code/data/app.db
  ```
- Артефакты — в `data/artifacts/` (цепочка/CRL/PEM/P12).

## Сборка документации
PlantUML → SVG, потом AsciiDoc; PDF/ppt(x) — в bindoc.
